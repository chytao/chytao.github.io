## 00-迁移工具简介

Rainbow迁移工具（简称“迁移工具”），提供将主机（X86服务器或其他特定虚拟化平台的虚拟机）系统及数据完整迁移到FusionCompute 6.3.0/6.3.1/6.5.RC1/6.5.0、FusionCloud2.0.6/ 6.3.0/6.3.1、HUAWEI CLOUD Stack 6.5 KVM虚拟化平台的功能。

## 01-迁移流程概述

![image-20200914223024754](https://gitee.com/hanstack/hanstack_image/raw/master/image/image-20200914223024754.png)

- 迁移前准备：用户准备满足迁移条件的源主机、Rainbow服务器、目的平台。

- 迁移：使用工具将源主机数据迁移至目的虚拟机。

- 测 试验证：用户验证迁移后的系统和应用是否可正常工作。

- 业务切换：用户停业务进行最后一次增量同步后将业务切换至目的虚拟机。

## 02-业务迁移方案交付

专业的迁移服务包括如下几个阶段：信息收集、迁移可行性分析、业务迁移风险及应对计划、迁移计划表制定、迁移方案制定、迁移工具及方案测试、业务迁移实施、业务迁移验收。

![image-20200914223155305](https://gitee.com/hanstack/hanstack_image/raw/master/image/image-20200914223155305.png)

1. 客户调研：
调研的内容包括以下几个方面:
- IT组织架构: 主要向客户IT人员调研客户的IT组织架构以及IT运作流程。
- IT硬件资产:了解客户目前业务系统的硬件信息，例如服务器类型、磁盘阵列类型等等，为业务迁移提供原始输入信息。
- 系统性能参数:通过部署信息采集工具，得到客户现行业务及IT设备具体信息，为客户业务云化评估、云平台容量规划和业务迁移提供最直接的信息。
- IT系统配置:通过了解客户目前配置和性能情况，评估迁移至我司云平台上性能情况，作为业务发放和资源配置的参考基准。
- 业务流程:要清楚客户业务流程，这样才能根据客户实际情况制定迁移方案。
- 业务&IT联系: 从IT的角度看，系统的优先级是怎样的。
- IT网络配置:了解客户目前组网情况。重点关注网络带宽信息。
- 迁移备份容灾需求:调研客户是否对业务有灾备需求。

- 客户其他要求:详细了解客户而对整个业务迁移的特殊需求，例如迁移时想将老的业务迁移到新的操作系统环境下，oracle数据库迁移时想直接从老版本迁移至最新版本，这些不仅要考虑到可行性，还要考虑到稳定性和兼容性问题。

2.迁移评估

- 主要通过采集客户IT设备信息和客户业务信息，在此基础上综合分析，得出业务可云化及可迁移性评估。

3.迁移风险及应对计划：

- 在新的云计算平台中，应用会部署到不同的硬件，甚至是操作系统上，能否实现应用的无缝迁移，是保证业务迁移成功的重要内容。我们要确保业务持久运行不中断。这就要求我们能够将宕机时间保证在合理的范围内从而实现业务连续性。如果需要和客户协议业务中断出现的保险责任问题，就需要明晰自己的底线。
- 业务迁移风险评估完成之后，针对例如搬迁的物理部件损坏，数据丢失，机器无法启动，业务无法启动等风险点，应该制定专门的应对措施。还应该针对每一类业务专门撰写应对计划，对所有可能涉及到的风险均加以描述和给出应对计划。计划完成之后和客户进行沟通，消除在业务迁移风险和应对计划上的分歧，在迁移风险及风险控制、应对上和客户达成一致。

4.迁移计划制定：

- 按照客户的需求，对业务迁移优先级进行排序。首先对业务迁移的关联性进行考虑，其次对业务迁移的迁移风险进行考虑，最后考虑迁移目标值，据此得出业务迁移顺序。
  一般情况下，由于客户的应用系统及设备数量众多，且各应用系统的重要程度、服务时段、依赖的设备情况等各不相同，因而建议采用分批次逐步迁移的方案，依据如下原则对设备进行分批次迁移：

- 先易后难。对于相对独立，关联系统少的应用，迁移到新的数据中心机房后，容易恢复正常运行。这类应用的迁移较为容易，可优先进行。
- 先普通业务系统，后核心业务系统。普通业务系统在迁移过程中出现问题，对公司日常经营活动造成的影响较小，可优先进行，为核心业务系统的迁移积累经验并验证迁移计划。
- 选择周末或节假日进行迁移。迁移前后需进行大量准备工作，迁移后需要进行大量测试工作，因而选择周末或节假日能使得迁移作具备充裕的时间，同时避免对日常业务工作造成影响。

5.迁移方案制定：

- 在确定迁移可行的基础上，对客户业务迁移制定详细的实施方案。包括迁移方法选定、迁移工具选型、迁移测试环境准备、迁移工具测试、业务迁移演练、正式迁移环境准备、迁移软件安装、迁移人员安排、迁移时间和停机时间安排、业务数据同步、验证业务、业务割接、业务再次验证、风险应对及失败回退等步骤。

6.迁移工具和方案测试：

- 在确定迁移方案和迁移工具之后，需要在后台云平台部署业务迁移工具环境，并对迁移工具和迁移方案进行测试。尽可能模拟客户真实情况，测试各种场景下方案和工具的可行性，并输出测试报告，项目组评审后和客户进行沟通，对迁移过程中出现的停机时间、风险点等再次进行沟通，和客户一起对迁移方案中需要修改的地方进行细化。

7.迁移实施

- 在迁移方案和迁移工具测试完成之后，按照和客户实现商定的迁移计划表进行业务迁移实施。具体实施包括前期准备工作，主要包括迁移软件准备、迁移人员安排；迁移实施阶段，包括客户系统备份、迁移软件安装、系统迁移、系统验证、差异数据同步、验证业务、业务割接、业务再次验证、业务回退等步骤。

8.迁移验收

- 在迁移完成之后，需要按照前期和客户既定的指标进行验收，完成相关指标的即宣告业务迁移成功。如果有些指标达不到要求，需要和客户沟通，进行整改或者向客户提交相关定位报告，达成谅解或者得到客户认可。

## 03-业务迁移顺序

![image-20200914223927231](https://gitee.com/hanstack/hanstack_image/raw/master/image/image-20200914223927231.png)

### 迁移原则

- 按照迁移风险从低到高

- 按照对业务影响从小到大

- 按照业务中断时间从长到短

- 按照业务复杂度从易到难

### 迁移顺序

- 基础服务
- 开发测试系统
- 办公系统
- IT管理系统
- 业务系统

### 迁移的内容和层次

**应用级业务迁移**

应用级业务迁移：使用专门的应用层迁移工具，在保证可用性前提下，从应用程序层面，将数据从旧系统迁移到新系统，满足客户迁移同时，完成对操作系统、数据库软件的升级。例如：Oracle和SQL SERVER的在线迁移。

**文件级业务迁移**

文件级业务迁移：根据客户的需要，通过迁移工具，将客户的工作负载以基于文件系统的方式，从源主机迁移到目标主机，以满足客户对磁盘规格的重规划、操作系统的升级。

**系统级业务迁移**

系统级业务迁移：客户的一台主机上运行了大量应用，可以通过迁移工具将主机硬件上的系统迁移到目标虚拟机，包括操作系统、应用程序和配置数据，主要用于系统盘的迁移。



## 04-按业务迁移场景划分的迁移类型

- P2V场景， P2V（Physical to Virtual） 指迁移物理服务器的操作系统及其上的应用软件和数据到华为UVP云平台虚拟服务器中。这种迁移方式，主要是使用各种工具软件，把物理服务器上的系统状态和数据“镜像”到 华为云平台提供的虚拟机中，并且在虚拟机中“替换”物理服务器的存储硬件与网卡驱动程序。只要在虚拟服务器中安装好相应的驱动程序并且设置与原来服务器相同的地址（如：IP 地址等），在重启虚拟机服务器后，虚拟服务器即可以替代物理服务器进行工作。

- V2V场景， V2V（Virtual to Virtual）迁移是在虚拟机之间移动操作系统和数据, 照顾主机级别的差异和处理不同的虚拟硬件，如VMware迁移到KVM，KVM 迁移到UVP。可以通过多种方式将虚拟机从一个VM Host系统移动到另一个VM Host系统。

- 华为云平台内部虚拟机业务迁移，是指虚拟机在同版本或跨版本FusionSphere平台上移动操作系统和数据。

## 05-Rainbow迁移涉及到的端口



![image-20200914230234563](https://gitee.com/hanstack/hanstack_image/raw/master/image/image-20200914230234563.png)

| 目的设备端口 | 目的设备端口说明                                             | 目的设备端口是否可更改 | 所属平面 |
| ------------ | ------------------------------------------------------------ | ---------------------- | -------- |
| 8443         | Tomcat  工程监听端口，迁移服务器内部使用                     | 否                     | 业务平面 |
| 8089         | Tomcat  工程监听端口，迁移服务器内部使用                     | 否                     | 业务平面 |
| 65432        | PostgreSQL数据库端口，迁移服务器内部使用                     | 否                     | 业务平面 |
| 445          | Smba协议端口，用于推送HconvertorAgent代理到源端              | 否                     | 业务平面 |
| 445          | Smba协议端口，用于目的端与源端通信，文件级迁移场景           | 否                     | 业务平面 |
| 8899         | HconvertorAgent代理的监听端口，用于迁移服务器与源端通信，端口可根据需要修改，前提是源端已开放对应端口 | 是                     | 业务平面 |
| 8899         | WinPE监听端口，用于迁移服务器与目的端通信                    | 否                     | 业务平面 |
| 8900         | 迁移端口，用于从源端迁移数据到目的端                         | 否                     | 业务平面 |
| 22           | SSH服务端口，用于迁移服务器与源端通信，端口可根据需要修改，前提是源端已开放对应端口 | 是                     | 业务平面 |
| 22           | SSH服务端口，用于迁移服务器与目的端通信                      | 是                     | 业务平面 |
| 22           | SSH服务端口，用于从源端迁移数据到目的端                      | 是                     | 业务平面 |
| 7443         | HTTPS协议的REST北向接口，用于迁移服务器与VRM节点通信         | 否                     | 管理平面 |

## 06-迁移原理

### windows块级迁移

![image-20200914230726556](https://gitee.com/hanstack/hanstack_image/raw/master/image/image-20200914230726556.png)

Step 1：VM挂载LiveCD，并从LiveCD启动，完成初始化配置。

Step 2：迁移服务器下发命令给目的VM，完成分区、格式。

Step 3：迁移服务器通过SSH连接迁移源，并下发迁移命令。

Step 4：复制迁移源数据到目的VM。

Step 5：迁移服务器发命令给VM，完成配置修改。

Step 6：重启VM，选择从硬盘启动。

### Linux文件级迁移

![image-20200914230848209](https://gitee.com/hanstack/hanstack_image/raw/master/image/image-20200914230848209.png)

Step 1：VM挂载LiveCD，并从LiveCD启动，完成初始化配置。

Step 2：迁移服务器下发命令给目的VM，完成分区、格式。

Step 3：迁移服务器通过SSH连接迁移源，并下发迁移命令。

Step 4：复制迁移源数据到目的VM。

Step 5：迁移服务器发命令给VM，完成配置修改。

Step 6：重启VM，选择从硬盘启动。

## 07-Rainbow迁移的实现原理

| 操作系统 | 块级迁移 | 文件级迁移        |
| -------- | -------- | ----------------- |
| Windows  | VSS      | VSS+CIFS+Fastcopy |
| Linux    | dd+ssh   | tar+rsync+ssh     |

### VSS(volume Shadow Copy Service):卷影复制

​	集成在windows操作系统中

请求者(Requestor)：其主要任务是初始化映射拷贝的创建

VSS书写器： 保证我们有一致的数据集要备份的组件。通常将其作为业务线应用程序（例如SQLServer®或Exchange Server）的一部分提供。

提供者(Provider)：其主要任务是创建映射拷贝；提供者是创建时间点影响的接口，它可以是基于存储阵列(硬件模式)，或者操作系统(软件模式)。VSS有不同的提供者，其层次关系为：最底层是硬件提供者，中间是软件提供者，最上面是系统软件提供者。其中前面两个提供者，是为第三方硬件或者软件厂商提供的。

卷映射拷贝服务(volume Shadow Copy Service)核心模块，其主要任务是协调各个模块的协作运行，并提供创建卷映射拷贝的方法；VSS提供了两种创建映射拷贝的方法：一种是完全拷贝(Clone/Full Copy/Split Mirror)，它会创建当前原始数据(Original Data)的全部拷贝；而另外一种就是写时才拷贝(Copy on Write/Differential Copy)，它只创建将要被更新的原始数据的拷贝。因此写拷贝创建映射拷贝速度快，但是恢复数据时需要使用原始数据。

![卷影复制服务的体系结构图](https://gitee.com/hanstack/hanstack_image/raw/master/image/ee923636.94dfb91e-8fc9-47c6-abc6-b96077196741(ws.10).jpg)

 第一步，请求者让VSS枚举所在卷上的写入者应用，并收集元数据(Metadata)。

 第二步，写入者可能通过XML文件来描述其组件(Components)，并定义其恢复(Restore)方法；其中，考虑到数据一致性，写入者需要一些相关处理，比如对于数据库应用来说，关闭所有打开的事务、回滚事务日志、以及将缓冲区中的数据写入等操作，直到所有数据准备好之后，通知VSS可以创建映射拷贝了。

第三步，VSS对于请求的卷，查询是否支持映射拷贝，并由那个提供者提供；因为在请求者管理应用中，会设置卷的映射拷贝属性以及策略等，所以需要进行查询和判断。

第四步，请求者通知VSS，要求在该卷上创建映射拷贝。

第五步，VSS锁住写入者应用，暂时不让写入新数据(在某些应用情况下，读操作请求是可以允许的)。

 第六步，VSS让提供者在磁盘上创建当前状态的映射拷贝(创建映射拷贝的速度，和创建的方法以及提供者的实现相关)。

第七步，创建映射拷贝完毕，VSS解锁写入者应用；然后写入者就可以处理队列中的写请求，接着VSS会查询是否这些写请求在创建映射拷贝期间被保证在队列中，如果是，则说明数据是一致的，否则说明可能数据一致性有问题，并做相应处理。

![卷影复制服务的工作原理示意图](https://gitee.com/hanstack/hanstack_image/raw/master/image/ee923636.1c481a14-d6bc-4796-a3ff-8c6e2174749b(ws.10).jpg)

**rsync**

从字面意思上，rsync 可以理解为 remote sync（远程同步），但它不仅可以远程同步数据（类似于 scp 命令），还可以本地同步数据（类似于 cp 命令）。不同于 cp 或 scp 的一点是，使用 rsync 命令备份数据时，不会直接覆盖以前的数据（如果数据已经存在），而是先判断已经存在的数据和新数据的差异，只有数据不同时才会把不相同的部分覆盖。

## 08-影响迁移效率的主要因素

- 专线网络带宽及网络质量
- 迁移源主机和目的的虚拟机的磁盘IO
- 迁移数据总量大小
- 源主机和目的主机的性能（CPU，内存等）

## 09-Rainbow的License

在未配置License的情况下，会进行并发数：2和迁移带宽10Mbps的限制，在配置License后，而无限制。

## 10-Rainbow迁移方式的选择

win：块级

linux：文件级

事实上，我们通常只考虑“Windows建议块级，Linux建议文件级”。因为Windows的块级迁移在配合NTFS文件系统，不会对未使用的空间进行拷贝且会进行数据压缩。因此，其并不会因为存在大量未使用空间造成迁移速度过慢，并且其会配合VSS影卷副本，不会造成数据受损；Linux只使用文件级，原因在于其块级会迁移未使用空间，且在未定格数据的情况下进行，存在造成数据受损的可能性。而文件级在使用tar+rsync及结果Linux系统文件并不庞大的情况下，其迁移速度较为理想。

## 11-Rainbow能否迁移数据库

不可以。原因是Rainbow只支持系统级迁移，迁移数据库业务无法保障数据一致性。建议采用数据库应用自身的业务迁移方案，例如Oracle的DataGuard或RMAN

## 12-Rainbow是否支持断点续传

支持

Windows块迁移采用VSS自身的断点续传机制
Linux文件级迁移，利用rcync完成断点续传。

## 13-Rainbow同步流程

​	迁移的时候，通过快照定格迁移数据。但是源端业务在线，一直有新的IO下发，会产生增量数据；需要对产生的增量数据做源端和目的端的数据同步，使得源端和目的端数据一致。同步完成后进行业务校验；校验成功后再进行业务切换。

![image-20200915001211968](https://gitee.com/hanstack/hanstack_image/raw/master/image/image-20200915001211968.png)

### 同步步骤

1.迁移前源端执行快照

2.迁移源端数据到目的VM

3.迁移周期产生增量数据

4.一次或者多次的业务在线同步，业务切换前将源端业务离线；进行数据同步。数据同步可以将迁移过程中源端产生呢个的增量数据同步到目的端，保证源端和目标端数据的一致性。

5.业务切换前可以进行一次或者多次同步，最后一次同步要求源端业务离线，其他同步操作可业务在线。

6.同步完成后，需要进行业务校验，业务校验成功后方可进行业务切换。